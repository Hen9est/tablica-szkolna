<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablica Informacyjna 2.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .ticker-text {
            animation: scroll 40s linear infinite;
        }
        @keyframes scroll {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        .skeleton {
            background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .pulse-dot {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">

    <!-- Status Bar -->
    <div id="status-bar" class="bg-green-500 text-white text-center py-1 text-sm hidden">
        <span id="status-text">System działa prawidłowo</span>
    </div>

    <header class="bg-white shadow-md sticky top-0 z-20">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <h1 id="school-name" class="text-2xl font-bold text-blue-600">Tablica Informacyjna</h1>
                <div id="connection-status" class="flex items-center space-x-1 text-sm">
                    <div id="status-dot" class="w-2 h-2 bg-gray-400 rounded-full pulse-dot"></div>
                    <span id="status-label" class="text-gray-500">Łączenie...</span>
                </div>
            </div>
            <div class="text-right">
                <div id="datetime" class="text-sm text-gray-600"></div>
                <div id="last-update" class="text-xs text-gray-400"></div>
            </div>
        </div>
    </header>

    <div class="bg-blue-100 border-b border-blue-200 py-3 overflow-hidden whitespace-nowrap">
        <div id="ticker-text" class="inline-block text-blue-800 font-semibold">Ładowanie informacji...</div>
    </div>

    <main class="container mx-auto p-4 flex-grow">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Zastępstwa -->
            <div class="bg-white rounded-lg shadow-md flex flex-col lg:col-span-2 max-h-[calc(100vh-200px)]">
                <div class="p-4 border-b flex justify-between items-center">
                    <h2 class="text-xl font-bold">Zastępstwa na dziś</h2>
                    <div id="substitutes-count" class="text-sm text-gray-500"></div>
                </div>
                <div id="substitutes-content" class="p-4 overflow-y-auto">
                    <div class="space-y-3">
                        <div class="skeleton h-4 w-full"></div>
                        <div class="skeleton h-4 w-3/4"></div>
                        <div class="skeleton h-4 w-1/2"></div>
                    </div>
                </div>
            </div>

            <!-- Dyżury -->
            <div class="bg-white rounded-lg shadow-md flex flex-col max-h-[calc(100vh-200px)]">
                <div class="p-4 border-b flex justify-between items-center">
                    <h2 class="text-xl font-bold">Dyżury na dziś</h2>
                    <div id="duties-count" class="text-sm text-gray-500"></div>
                </div>
                <div id="duties-content" class="p-4 overflow-y-auto">
                    <div class="space-y-3">
                        <div class="skeleton h-4 w-full"></div>
                        <div class="skeleton h-4 w-2/3"></div>
                        <div class="skeleton h-4 w-1/2"></div>
                    </div>
                </div>
            </div>

            <!-- Ogłoszenia -->
            <div class="bg-white rounded-lg shadow-md flex flex-col lg:col-span-3 max-h-[calc(100vh-200px)]">
                <div class="p-4 border-b flex justify-between items-center">
                    <h2 class="text-xl font-bold">Ogłoszenia</h2>
                    <div id="announcements-count" class="text-sm text-gray-500"></div>
                </div>
                <div id="announcements-content" class="p-4 overflow-y-auto">
                    <div class="space-y-4">
                        <div class="skeleton h-20 w-full rounded-lg"></div>
                        <div class="skeleton h-16 w-full rounded-lg"></div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Configuration Modal -->
    <div id="config-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg p-6 w-full max-w-md">
                <h3 class="text-lg font-bold mb-4">Konfiguracja systemu</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">URL Google Apps Script</label>
                        <input type="url" id="apps-script-url" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" 
                               placeholder="https://script.google.com/macros/s/...">
                        <p class="text-xs text-gray-500 mt-1">Wklej URL wdrożonego skryptu Google Apps Script</p>
                    </div>
                    <div class="flex space-x-3">
                        <button id="save-config" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md text-sm font-medium hover:bg-blue-700">
                            Zapisz
                        </button>
                        <button id="cancel-config" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-md text-sm font-medium hover:bg-gray-400">
                            Anuluj
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== KONFIGURACJA I STAŁE =====
        const CONFIG = {
            REFRESH_INTERVAL: 300000, // 5 minut
            CACHE_DURATION: 120000,   // 2 minuty
            RETRY_ATTEMPTS: 3,
            RETRY_DELAY: 2000,
            REQUEST_TIMEOUT: 10000
        };

        let APPS_SCRIPT_URL = localStorage.getItem('appsScriptUrl') || '';
        
        // Globalny cache z timestampami
        const dataCache = new Map();
        
        // Status połączenia
        let connectionStatus = 'connecting';
        let lastUpdateTime = null;
        let retryCount = 0;

        // ===== UTILITY FUNCTIONS =====
        
        /**
         * Normalizuje string: usuwa polskie znaki i zamienia na małe litery
         */
        function normalizeString(str) {
            if (!str) return '';
            return str.toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }

        /**
         * Formatuje czas względny (np. "2 minuty temu")
         */
        function formatRelativeTime(timestamp) {
            const now = Date.now();
            const diffMinutes = Math.floor((now - timestamp) / 60000);
            
            if (diffMinutes < 1) return 'przed chwilą';
            if (diffMinutes === 1) return '1 minutę temu';
            if (diffMinutes < 60) return `${diffMinutes} minut temu`;
            
            const diffHours = Math.floor(diffMinutes / 60);
            if (diffHours === 1) return '1 godzinę temu';
            return `${diffHours} godzin temu`;
        }

        /**
         * Pobiera dane z cache jeśli są świeże
         */
        function getCachedData(action) {
            const cached = dataCache.get(action);
            if (cached && (Date.now() - cached.timestamp < CONFIG.CACHE_DURATION)) {
                console.log(`Cache hit dla akcji: ${action}`);
                return cached.data;
            }
            return null;
        }

        /**
         * Zapisuje dane do cache
         */
        function setCachedData(action, data) {
            dataCache.set(action, {
                data: data,
                timestamp: Date.now()
            });
            // Zapisz też do localStorage jako backup
            try {
                localStorage.setItem(`cache_${action}`, JSON.stringify({data, timestamp: Date.now()}));
            } catch (e) {
                console.warn('Nie można zapisać do localStorage:', e);
            }
        }

        /**
         * Pobiera dane z localStorage jako fallback
         */
        function getOfflineData(action) {
            try {
                const stored = localStorage.getItem(`cache_${action}`);
                if (stored) {
                    const parsed = JSON.parse(stored);
                    return parsed.data;
                }
            } catch (e) {
                console.warn('Błąd odczytu offline data:', e);
            }
            return [];
        }

        /**
         * Aktualizuje status połączenia
         */
        function updateConnectionStatus(status, message = '') {
            connectionStatus = status;
            const dot = document.getElementById('status-dot');
            const label = document.getElementById('status-label');
            
            switch (status) {
                case 'connected':
                    dot.className = 'w-2 h-2 bg-green-500 rounded-full';
                    label.textContent = 'Online';
                    label.className = 'text-green-600 text-xs font-medium';
                    retryCount = 0;
                    break;
                case 'error':
                    dot.className = 'w-2 h-2 bg-red-500 rounded-full pulse-dot';
                    label.textContent = 'Błąd połączenia';
                    label.className = 'text-red-600 text-xs font-medium';
                    break;
                case 'offline':
                    dot.className = 'w-2 h-2 bg-yellow-500 rounded-full';
                    label.textContent = 'Tryb offline';
                    label.className = 'text-yellow-600 text-xs font-medium';
                    break;
                default:
                    dot.className = 'w-2 h-2 bg-gray-400 rounded-full pulse-dot';
                    label.textContent = 'Łączenie...';
                    label.className = 'text-gray-500 text-xs';
            }
        }

        /**
         * Pobiera dane z Google Apps Script z retry logic i cache
         */
        async function fetchSheetData(action, attempt = 1) {
            // Sprawdź cache najpierw
            const cached = getCachedData(action);
            if (cached) {
                return cached;
            }

            if (!APPS_SCRIPT_URL) {
                showConfigModal();
                throw new Error('Brak skonfigurowanego URL Apps Script');
            }

            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_' + Math.floor(Date.now() * Math.random());
                const script = document.createElement('script');
                const timeoutId = setTimeout(() => {
                    cleanup();
                    if (attempt < CONFIG.RETRY_ATTEMPTS) {
                        console.log(`Timeout dla ${action}, próba ${attempt + 1}/${CONFIG.RETRY_ATTEMPTS}`);
                        setTimeout(() => {
                            fetchSheetData(action, attempt + 1).then(resolve).catch(reject);
                        }, CONFIG.RETRY_DELAY * attempt);
                    } else {
                        updateConnectionStatus('error');
                        const offlineData = getOfflineData(action);
                        if (offlineData.length > 0) {
                            updateConnectionStatus('offline');
                            resolve(offlineData);
                        } else {
                            reject(new Error(`Timeout po ${CONFIG.RETRY_ATTEMPTS} próbach`));
                        }
                    }
                }, CONFIG.REQUEST_TIMEOUT);

                const cleanup = () => {
                    clearTimeout(timeoutId);
                    if (script.parentNode) {
                        document.body.removeChild(script);
                    }
                    delete window[callbackName];
                };

                script.src = `${APPS_SCRIPT_URL}?action=${action}&callback=${callbackName}&cachebust=${Date.now()}&v=2.1`;

                window[callbackName] = (data) => {
                    cleanup();
                    if (data.error) {
                        console.error(`Błąd serwera dla ${action}:`, data.error);
                        if (attempt < CONFIG.RETRY_ATTEMPTS) {
                            setTimeout(() => {
                                fetchSheetData(action, attempt + 1).then(resolve).catch(reject);
                            }, CONFIG.RETRY_DELAY * attempt);
                        } else {
                            updateConnectionStatus('error');
                            const offlineData = getOfflineData(action);
                            resolve(offlineData);
                        }
                    } else {
                        const result = data.data || [];
                        setCachedData(action, result);
                        updateConnectionStatus('connected');
                        lastUpdateTime = Date.now();
                        resolve(result);
                    }
                };

                script.onerror = () => {
                    cleanup();
                    if (attempt < CONFIG.RETRY_ATTEMPTS) {
                        console.log(`Błąd ładowania skryptu dla ${action}, próba ${attempt + 1}/${CONFIG.RETRY_ATTEMPTS}`);
                        setTimeout(() => {
                            fetchSheetData(action, attempt + 1).then(resolve).catch(reject);
                        }, CONFIG.RETRY_DELAY * attempt);
                    } else {
                        updateConnectionStatus('error');
                        const offlineData = getOfflineData(action);
                        resolve(offlineData);
                    }
                };
                
                document.body.appendChild(script);
            });
        }

        // ===== UI UPDATE FUNCTIONS =====

        /**
         * Aktualizuje datę i czas
         */
        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            };
            document.getElementById('datetime').textContent = now.toLocaleDateString('pl-PL', options);
            
            // Aktualizuj "ostatnio zaktualizowano"
            if (lastUpdateTime) {
                document.getElementById('last-update').textContent = 
                    `Aktualizacja: ${formatRelativeTime(lastUpdateTime)}`;
            }
        }

        /**
         * Ładuje konfigurację ogólną
         */
        async function loadConfiguration() {
            try {
                const data = await fetchSheetData('getConfiguration');
                const config = data.reduce((acc, item) => ({ ...acc, [item.Klucz]: item.Wartość }), {});
                
                document.getElementById('school-name').textContent = config['NazwaSzkoly'] || 'Tablica Informacyjna';
                
                const tickerText = config['PasekInfo'] || 'Brak komunikatów';
                const tickerElement = document.getElementById('ticker-text');
                tickerElement.textContent = tickerText;
                tickerElement.classList.add('fade-in');
            } catch (error) {
                console.error('Błąd ładowania konfiguracji:', error);
                document.getElementById('ticker-text').textContent = 'Błąd połączenia z serwerem';
            }
        }

        /**
         * Ładuje i wyświetla zastępstwa na dziś
         */
        async function loadSubstitutes() {
            const container = document.getElementById('substitutes-content');
            const countElement = document.getElementById('substitutes-count');
            
            try {
                const data = await fetchSheetData('getSubstitutes');
                const currentDayName = normalizeString(new Date().toLocaleDateString('pl-PL', { weekday: 'long' }));
                const todaySubstitutes = data.filter(sub => normalizeString(sub.DzienTygodnia) === currentDayName);

                countElement.textContent = `${todaySubstitutes.length} ${todaySubstitutes.length === 1 ? 'zastępstwo' : 'zastępstw'}`;

                if (todaySubstitutes.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 italic py-8 fade-in">Brak zastępstw na dziś 🎉</div>';
                    return;
                }
                
                let html = `<div class="fade-in">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-500 uppercase bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 font-semibold">Godz.</th>
                                <th class="px-3 py-2 font-semibold">Za kogo</th>
                                <th class="px-3 py-2 font-semibold">Kto zastępuje</th>
                                <th class="px-3 py-2 font-semibold">Klasa</th>
                                <th class="px-3 py-2 font-semibold">Uwagi</th>
                            </tr>
                        </thead>
                        <tbody>`;
                
                todaySubstitutes.forEach((row, index) => {
                    const rowClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                    html += `<tr class="${rowClass} border-b hover:bg-blue-50 transition-colors">
                        <td class="px-3 py-3 font-bold text-blue-600">${row.Godzina || '-'}</td>
                        <td class="px-3 py-3">${row.ZaKogo || '-'}</td>
                        <td class="px-3 py-3 font-semibold text-gray-800">${row.KtoZastepuje || '-'}</td>
                        <td class="px-3 py-3">${row.Klasa || '-'}</td>
                        <td class="px-3 py-3 text-gray-500 text-xs">${row.Uwagi || ''}</td>
                    </tr>`;
                });
                container.innerHTML = html + '</tbody></table></div>';
            } catch (error) {
                console.error('Błąd ładowania zastępstw:', error);
                container.innerHTML = '<div class="text-center text-red-500 py-8">Błąd ładowania zastępstw</div>';
                countElement.textContent = 'Błąd';
            }
        }

        /**
         * Ładuje i wyświetla ogłoszenia
         */
        async function loadAnnouncements() {
            const container = document.getElementById('announcements-content');
            const countElement = document.getElementById('announcements-count');
            
            try {
                const data = await fetchSheetData('getAnnouncements');
                
                countElement.textContent = `${data.length} ${data.length === 1 ? 'ogłoszenie' : 'ogłoszeń'}`;
                
                if (data.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 italic py-8 fade-in">Brak nowych ogłoszeń</div>';
                    return;
                }

                const html = data.map((ann, index) => `
                    <div class="p-4 mb-4 bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg border border-blue-200 fade-in" 
                         style="animation-delay: ${index * 0.1}s">
                        <h3 class="font-bold text-lg text-blue-800 mb-2">${ann.Tytul || 'Bez tytułu'}</h3>
                        <p class="text-gray-700 leading-relaxed">${ann.Tresc || 'Brak treści'}</p>
                    </div>
                `).join('');

                container.innerHTML = html;
            } catch (error) {
                console.error('Błąd ładowania ogłoszeń:', error);
                container.innerHTML = '<div class="text-center text-red-500 py-8">Błąd ładowania ogłoszeń</div>';
                countElement.textContent = 'Błąd';
            }
        }

        /**
         * Ładuje i wyświetla dyżury na dziś
         */
        async function loadDuties() {
            const container = document.getElementById('duties-content');
            const countElement = document.getElementById('duties-count');
            
            try {
                const data = await fetchSheetData('getDuties');
                const currentDayName = normalizeString(new Date().toLocaleDateString('pl-PL', { weekday: 'long' }));
                const todayDuties = data.filter(duty => normalizeString(duty.DzienTygodnia) === currentDayName);

                countElement.textContent = `${todayDuties.length} ${todayDuties.length === 1 ? 'dyżur' : 'dyżurów'}`;

                if (todayDuties.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 italic py-8 fade-in">Brak dyżurów na dziś</div>';
                    return;
                }
                
                // Grupuj dyżury po przerwach
                const dutiesByBreak = todayDuties.reduce((acc, duty) => {
                    const breakTime = duty.Przerwa || 'Inne';
                    if (!acc[breakTime]) {
                        acc[breakTime] = [];
                    }
                    acc[breakTime].push(duty);
                    return acc;
                }, {});

                let html = '<div class="space-y-4 fade-in">';
                Object.keys(dutiesByBreak).forEach((breakTime, index) => {
                    html += `<div class="fade-in" style="animation-delay: ${index * 0.1}s">
                        <h4 class="font-semibold text-gray-700 bg-gradient-to-r from-gray-100 to-gray-200 px-3 py-2 rounded-md mb-3 border-l-4 border-blue-500">
                            ${breakTime}
                        </h4>
                        <div class="space-y-2 ml-2">`;
                    
                    dutiesByBreak[breakTime].forEach(duty => {
                        html += `<div class="flex justify-between items-center p-2 bg-gray-50 rounded border-l-2 border-gray-300 hover:border-blue-400 transition-colors">
                            <span class="text-sm text-gray-600">${duty.Sektor || '-'}</span>
                            <span class="font-medium text-gray-800 text-sm">${duty.Nauczyciel || '-'}</span>
                        </div>`;
                    });

                    html += `</div></div>`;
                });
                container.innerHTML = html + '</div>';
            } catch (error) {
                console.error('Błąd ładowania dyżurów:', error);
                container.innerHTML = '<div class="text-center text-red-500 py-8">Błąd ładowania dyżurów</div>';
                countElement.textContent = 'Błąd';
            }
        }

        // ===== CONFIGURATION MODAL =====
        
        function showConfigModal() {
            document.getElementById('config-modal').classList.remove('hidden');
            document.getElementById('apps-script-url').value = APPS_SCRIPT_URL;
        }

        function hideConfigModal() {
            document.getElementById('config-modal').classList.add('hidden');
        }

        // ===== MAIN REFRESH FUNCTION =====
        
        async function refreshAllData() {
            console.log("🔄 Odświeżanie danych...");
            
            if (!APPS_SCRIPT_URL) {
                showConfigModal();
                return;
            }

            try {
                // Równoległe ładowanie wszystkich sekcji
                await Promise.allSettled([
                    loadConfiguration(), 
                    loadSubstitutes(), 
                    loadAnnouncements(), 
                    loadDuties()
                ]);
                
                console.log("✅ Dane załadowane pomyślnie");
                lastUpdateTime = Date.now();
            } catch (error) {
                console.error("❌ Błąd podczas odświeżania:", error);
                updateConnectionStatus('error');
            }
        }

        // ===== EVENT LISTENERS =====
        
        document.addEventListener('DOMContentLoaded', () => {
            // Aktualizuj czas
            updateDateTime();
            setInterval(updateDateTime, 60000);
            
            // Konfiguracja modal
            document.getElementById('save-config').addEventListener('click', () => {
                const url = document.getElementById('apps-script-url').value.trim();
                if (url) {
                    APPS_SCRIPT_URL = url;
                    localStorage.setItem('appsScriptUrl', url);
                    hideConfigModal();
                    // Wyczyść cache przy zmianie URL
                    dataCache.clear();
                    refreshAllData();
                } else {
                    alert('Proszę wpisać prawidłowy URL');
                }
            });

            document.getElementById('cancel-config').addEventListener('click', hideConfigModal);

            // Zamknij modal przy kliknięciu tła
            document.getElementById('config-modal').addEventListener('click', (e) => {
                if (e.target.id === 'config-modal') {
                    hideConfigModal();
                }
            });

            // Skrót klawiszowy do konfiguracji (Ctrl+K)
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'k') {
                    e.preventDefault();
                    showConfigModal();
                }
            });

            // Odświeżanie przy fokusie okna
            window.addEventListener('focus', () => {
                if (Date.now() - lastUpdateTime > CONFIG.CACHE_DURATION) {
                    refreshAllData();
                }
            });

            // Pierwsze załadowanie
            refreshAllData();
            
            // Okresowe odświeżanie
            setInterval(refreshAllData, CONFIG.REFRESH_INTERVAL);
        });

        // Service worker registration (jeśli dostępny)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(() => {
                    console.log('Service Worker nie jest dostępny');
                });
            });
        }
    </script>
</body>
</html>
